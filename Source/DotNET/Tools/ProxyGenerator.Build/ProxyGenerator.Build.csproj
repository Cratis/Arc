<Project Sdk="Microsoft.NET.Sdk">
    <PropertyGroup>
        <AssemblyName>Cratis.Arc.ProxyGenerator.Build</AssemblyName>
        <OutputType>Exe</OutputType>
        <TargetFramework>net10.0</TargetFramework>
        <NoPackageAnalysis>true</NoPackageAnalysis>
        <BuildOutputTargetFolder>tasks</BuildOutputTargetFolder>
        <NoWarn>$(NoWarn);NU5118</NoWarn>
        <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
    </PropertyGroup>

    <ItemGroup>
        <PackageReference Include="handlebars.net" />
        <PackageReference Include="Microsoft.Extensions.DependencyModel" />
        <PackageReference Include="System.Reflection.MetadataLoadContext" />
    </ItemGroup>

    <ItemGroup>
        <Content Include="build\*" PackagePath="build\" />
    </ItemGroup>

    <ItemGroup>
        <PackageReference Include="Microsoft.Build.Framework" />
        <PackageReference Include="Microsoft.Build.Utilities.Core" />
    </ItemGroup>

    <ItemGroup>
        <Compile Include="$(MSBuildThisFileDirectory)../ProxyGenerator/**/*.cs" Exclude="../ProxyGenerator/obj/**/*.cs"/>
    </ItemGroup>

    <ItemGroup>
        <EmbeddedResource Include="$(MSBuildThisFileDirectory)../ProxyGenerator/Templates/**/*.hbs">
             <LogicalName>Cratis.Arc.ProxyGenerator.Templates.%(RecursiveDir)%(Filename)%(Extension)</LogicalName>
        </EmbeddedResource>
    </ItemGroup>

    <!-- Copy dependency files during pack using resolved assembly references -->
    <Target Name="IncludeDependencyFiles" BeforeTargets="GenerateNuspec" AfterTargets="ResolveReferences">
        <Message Importance="High" Text="Including dependency files in the NuGet package..." />
        <ItemGroup>
            <!-- Find the actual resolved assemblies -->
            <HandlebarsAssembly Include="@(ReferencePath)" Condition="'%(Filename)' == 'Handlebars'" />
            <DependencyModelAssembly Include="@(ReferencePath)" Condition="'%(Filename)' == 'Microsoft.Extensions.DependencyModel'" />
            <MetadataLoadContextAssembly Include="@(ReferencePath)" Condition="'%(Filename)' == 'System.Reflection.MetadataLoadContext'" />
        </ItemGroup>

        <Message Importance="High" Text="Resolved Handlebars assembly: @(HandlebarsAssembly)" />
        
        <ItemGroup>
            <!-- Include the resolved assemblies in both net8.0, net9.0 and net10.0 task folders -->
            <Content Include="@(HandlebarsAssembly)" PackagePath="tasks/net8.0/" />
            <Content Include="@(DependencyModelAssembly)" PackagePath="tasks/net8.0/" />
            <Content Include="@(MetadataLoadContextAssembly)" PackagePath="tasks/net8.0/" />
            
            <Content Include="@(HandlebarsAssembly)" PackagePath="tasks/net9.0/" />
            <Content Include="@(DependencyModelAssembly)" PackagePath="tasks/net9.0/" />
            <Content Include="@(MetadataLoadContextAssembly)" PackagePath="tasks/net9.0/" />

            <Content Include="@(HandlebarsAssembly)" PackagePath="tasks/net10.0/" />
            <Content Include="@(DependencyModelAssembly)" PackagePath="tasks/net10.0/" />
            <Content Include="@(MetadataLoadContextAssembly)" PackagePath="tasks/net10.0/" />
        </ItemGroup>
    </Target>

    <!-- Include output from the ProxyGenerator -->
    <ItemGroup>
        <Content Include="$(MSBuildThisFileDirectory)bin/$(Configuration)/net8.0/**/*" PackagePath="tasks/net8.0" />
        <Content Include="$(MSBuildThisFileDirectory)bin/$(Configuration)/net9.0/**/*" PackagePath="tasks/net9.0" />
        <Content Include="$(MSBuildThisFileDirectory)bin/$(Configuration)/net10.0/**/*" PackagePath="tasks/net10.0" />
    </ItemGroup>       
</Project>
