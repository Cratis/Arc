<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <TargetFrameworkFolder Condition=" '$(TargetFramework)' == 'net8.0' ">net8.0</TargetFrameworkFolder>
        <TargetFrameworkFolder Condition=" '$(TargetFramework)' == 'net9.0' ">net9.0</TargetFrameworkFolder>
        <TargetFrameworkFolder Condition=" '$(TargetFramework)' == 'net10.0' ">net10.0</TargetFrameworkFolder>

        <CratisProxyDevAssemblyDirectory>$(MSBuildThisFileDirectory)../../ProxyGenerator.Build/bin/$(Configuration)/$(TargetFrameworkFolder)</CratisProxyDevAssemblyDirectory>
        <CratisProxyPackedAssemblyDirectory>$(MSBuildThisFileDirectory)../tasks/$(TargetFrameworkFolder)</CratisProxyPackedAssemblyDirectory>

        <CratisProxyGeneratorAssemblyDirectory Condition="Exists($(CratisProxyPackedAssemblyDirectory)) == true">$(CratisProxyPackedAssemblyDirectory)</CratisProxyGeneratorAssemblyDirectory>
        <CratisProxyGeneratorAssemblyDirectory Condition="Exists($(CratisProxyPackedAssemblyDirectory)) == false">$(CratisProxyDevAssemblyDirectory)</CratisProxyGeneratorAssemblyDirectory>
        <CratisProxyGeneratorAssembly>Cratis.Arc.ProxyGenerator.Build.dll</CratisProxyGeneratorAssembly>
    </PropertyGroup>
    
    <Target Name="CratisProxyGenerator" AfterTargets="AfterBuild"> 
        <PropertyGroup>
            <CratisProxiesOutputPath>$([System.String]::Copy('$(CratisProxiesOutputPath)').TrimEnd('\'))</CratisProxiesOutputPath>
        </PropertyGroup>

        <Message Text="MSBuildProjectDirectory : $(MSBuildProjectDirectory)" Importance="high" />
        <Message Text="OutputPath : $(OutputPath)" Importance="high" />
        <Message Text="ProxiesOutputPath : $(CratisProxiesOutputPath)" Importance="high" />
        <Message Text="AssemblyName : $(AssemblyName)" Importance="high" />
        <Message Text="ProxyGenerator base directory : $(CratisProxyGeneratorAssemblyDirectory)" Importance="high" />
        <Message Text="Full path to assembly : $(MSBuildProjectDirectory)/$(OutputPath)$(AssemblyName).dll" Importance="high" />
        
        <PropertyGroup>
            <SkipOutputDeletion Condition=" '$(CratisProxiesSkipOutputDeletion)' == 'true' ">--skip-output-deletion</SkipOutputDeletion>
            <SkipCommandNameInRoute Condition=" '$(CratisProxiesSkipCommandNameInRoute)' == 'true' ">--skip-command-name-in-route</SkipCommandNameInRoute>
            <SkipQueryNameInRoute Condition=" '$(CratisProxiesSkipQueryNameInRoute)' == 'true' ">--skip-query-name-in-route</SkipQueryNameInRoute>
            <ApiPrefix Condition=" '$(CratisProxiesApiPrefix)' != '' ">--api-prefix=$(CratisProxiesApiPrefix)</ApiPrefix>
            <SkipFileIndexTracking Condition=" '$(CratisProxiesSkipFileIndexTracking)' == 'true' ">--skip-file-index-tracking</SkipFileIndexTracking>
            <SkipIndexGeneration Condition=" '$(CratisProxiesSkipIndexGeneration)' == 'true' ">--skip-index-generation</SkipIndexGeneration>
        </PropertyGroup>

        <Exec ConsoleToMsBuild="true" 
            Command="dotnet $(CratisProxyGeneratorAssembly) &quot;$(MSBuildProjectDirectory)/$(OutputPath)$(AssemblyName).dll&quot; &quot;$(CratisProxiesOutputPath)&quot; $(CratisProxiesSegmentsToSkip) $(SkipOutputDeletion) $(SkipCommandNameInRoute) $(SkipQueryNameInRoute) $(ApiPrefix) --project-directory=&quot;$(MSBuildProjectDirectory)&quot; $(SkipFileIndexTracking) $(SkipIndexGeneration)"
            WorkingDirectory="$(CratisProxyGeneratorAssemblyDirectory)" />
    </Target>
</Project>
